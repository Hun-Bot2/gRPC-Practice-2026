# gRPC Practice 2026 - 수정 사항 정리

## 작업 일자
2026년 1월 6일

---

## 작업 개요
기본 gRPC 서비스 구현 및 2026년 최신 버전 호환성 문제 해결

---

## 최종 폴더 구조

```
productinfo/
├── service/
│   ├── go.mod
│   ├── go.sum
│   ├── main.go
│   ├── product_info.proto
│   ├── product_info_service.go
│   └── ecommerce/
│       ├── product_info.pb.go         (메시지 정의 스텁)
│       └── product_info_grpc.pb.go    (gRPC 서비스 스텁)
└── client/
    ├── go.mod
    ├── go.sum
    ├── main.go
    └── ecommerce/
        ├── product_info.pb.go          (메시지 정의 스텁)
        └── product_info_grpc.pb.go     (gRPC 클라이언트 스텁)
```

---

## 주요 수정 사항

### 1. Proto 정의 파일 생성
**파일**: `service/product_info.proto`

```protobuf
syntax = "proto3";
package ecommerce;
option go_package = "productinfo/service";

service ProductInfo {
    rpc addProduct(Product) returns (ProductID);
    rpc getProduct(ProductID) returns (Product);
}

message Product {
    string id = 1;
    string name = 2;
    string description = 3;
    float price = 4;
}

message ProductID {
    string value = 1;
}
```

---

### 2. 서버 구현
**파일**: `service/product_info_service.go`

```go
type server struct {
	productMap map[string]*pb.Product
	pb.UnimplementedProductInfoServer  // 필수 임베딩
}
```

**주요 메서드**:
- `AddProduct`: 제품 추가 (UUID로 ID 자동 생성)
- `GetProduct`: 제품 ID로 조회

---

### 3. gRPC 버전 호환성 문제 해결

#### 문제
- 생성된 스텁: gRPC v1.64.0+ 요구 (`SupportPackageIsVersion9`, `StaticMethod`)
- go.mod: gRPC v1.56.0 사용

#### 해결
**service/go.mod & client/go.mod**:
```go.mod
require (
    google.golang.org/grpc v1.64.0  // v1.56.0 → v1.64.0 업그레이드
    google.golang.org/protobuf v1.36.11
)
```

---

### 4. 누락된 gRPC 스텁 파일 재생성

#### 문제
- `ecommerce/` 폴더에 `product_info_grpc.pb.go` 없음
- `RegisterProductInfoServer`, `NewProductInfoClient` 등 함수 미정의

#### 해결
```bash
protoc --go_out=ecommerce --go_opt=paths=source_relative \
       --go-grpc_out=ecommerce --go-grpc_opt=paths=source_relative \
       product_info.proto
```

**중요**: 2020년 3월 이후부터는 두 개의 파일 필수
- `product_info.pb.go`: 메시지 정의
- `product_info_grpc.pb.go`: gRPC 서비스 함수

---

### 5. status.Errorf 포맷 문자열 수정

#### 문제
```go
return nil, status.Errorf(codes.Internal, "Error while generating Product ID", err)
//                                         ↑ 포맷 지시자 없음
```

#### 해결
```go
// Before
status.Errorf(codes.Internal, "Error while generating Product ID", err)
status.Errorf(codes.NotFound, "Product does not exist.", in.Value)

// After
status.Errorf(codes.Internal, "Error while generating Product ID: %v", err)
status.Errorf(codes.NotFound, "Product does not exist: %v", in.Value)
```

---

### 6. 의존성 동기화

#### 문제
- go.mod에 선언된 모듈이 다운로드되지 않음
- import 에러 발생

#### 해결
```bash
cd productinfo/service && go mod tidy
cd productinfo/client && go mod tidy
```

---

## gRPC-Go 버전 변화 (2020년 전후)

### 구버전 (2020년 3월 이전)
```
productinfo/ecommerce/
└── product_info.pb.go  ← 메시지 + gRPC 서비스 모두 포함
```

### 신버전 (2020년 3월 이후 ~ 현재)
```
productinfo/ecommerce/
├── product_info.pb.go       ← protoc-gen-go (메시지만)
└── product_info_grpc.pb.go  ← protoc-gen-go-grpc (gRPC만)
```

**이유**: Google의 Protocol Buffers 리팩토링으로 관심사 분리

---

## 최종 의존성

### service/go.mod
```go.mod
require (
    github.com/google/uuid v1.6.0
    google.golang.org/grpc v1.64.0
    google.golang.org/protobuf v1.36.11
)
```

### client/go.mod
```go.mod
require (
    google.golang.org/grpc v1.64.0
    google.golang.org/protobuf v1.36.11
)
```

---

## 테스트 방법

### 서버 실행
```bash
cd productinfo/service
go run main.go product_info_service.go
```

### 클라이언트 실행
```bash
cd productinfo/client
go run main.go
```

### 예상 출력
```
# Server
Product <uuid> : Apple iPhone 11 - Added.
Product <uuid> : Apple iPhone 11 - Retrieved.

# Client
Product ID: <uuid> added successfully
Product: id:"<uuid>" name:"Apple iPhone 11" description:"..." price:699
```

---

## 배운 점

1. **gRPC 코드 생성 방식 변화**: 2020년 이후 스텁 파일이 2개로 분리됨
2. **버전 호환성 중요성**: 생성된 코드와 go.mod 버전이 일치해야 함
3. **포맷 문자열 규칙**: `status.Errorf`는 printf 스타일 포맷 필요
4. **의존성 관리**: `go mod tidy`로 명시적 동기화 필요
5. **빌드 플래그 변경**: Go 1.16부터 `-i` 플래그 제거됨

---

## 빌드 명령어 변경

### 구버전 (Go 1.15 이하)
```bash
go build -i -v -o bin/server
```

### 현재 버전 (Go 1.16+)
```bash
go build -v -o bin/server
```

**이유**: Go 1.16부터 `-i` (install packages) 플래그가 제거됨. 자동 패키지 캐싱으로 불필요해짐.

---

## Proto 관련 학습 리소스


- [Protocol Buffers 공식 문서](https://protobuf.dev/)
- [gRPC Go Quick Start](https://grpc.io/docs/languages/go/quickstart/)
- [Protocol Buffers Language Guide](https://protobuf.dev/programming-guides/proto3/)
- [gRPC Go Tutorial](https://grpc.io/docs/languages/go/basics/)
